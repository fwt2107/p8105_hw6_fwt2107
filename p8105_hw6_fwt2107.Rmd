---
title: "p8105_hw6_fwt2107"
author: "Felix Tran"
date: "November 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "right"))
```

# Problem 1

### Data cleaning

1. Read in the dataset from the Washington Post's github page

2. Create a **city_state** variable to combine each homicide's city and state

3. Remove all homicides which were recorded in Dallas, TX; Phoenix, AZ; Kansas
City, MO; and Tulsa, AL

4. Transform **victim_age** into a numeric variable

5. Transform **victim_race** into a binary variable (white vs. non-white)

6. Create a **solved_binary** binary variable for the outcome of each homicide
(1 (solved) vs. 0 (unsolved))
```{r}
data_url <- RCurl::getURL('https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv')

homicide_df <- readr::read_csv(data_url) %>% 
  mutate(city_state = stringr::str_c(city, ', ',state)) %>% 
  filter(!(city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO', 
                             'Tulsa, AL'))) %>% 
  mutate(victim_age = as.numeric(victim_age),
         victim_race = ifelse(victim_race == "White", "white", "non-white"),
         solved_binary = ifelse(disposition == "Closed by arrest", 1, 0))
```

### Fitting a logistic regression model for resolved vs. unresolved homicides
### in Baltimore, MD

1. Use the *glm()* function to run a logistic regression modeling the logit
of the probability of a murder being resolved on victim age, sex, and race
in Baltimore, MD.

2. Use *broom::tidy()* to clean the output and compute the OR's and 95% CI for
the estimates
```{r}
baltimore_log <- glm(solved_binary ~ victim_age + victim_sex + victim_race,
                     data = homicide_df, family = binomial())

baltimore_log %>% 
  broom::tidy(.) %>% 
  mutate(OR = exp(estimate),
         CI_lower_limit = exp(estimate - 1.96*std.error),
         CI_upper_limit = exp(estimate + 1.96*std.error)) %>% 
  select(term, estimate, OR, CI_lower_limit, CI_upper_limit)
```
After adjusting for victim age and sex, homicides in Baltimore, MD in which the 
victim was white had approximately 1.78 times the odds of being resolved 
compared to homicides in which the victim was non-white. We are 95% confident
that Baltimore homicides involving white victims had between 1.68 to 1.89 times
the odds of being resolved compared to homicides involving non-white victims.

### Fitting a logistic regression model for resolved vs. unresolved homicides
### in all cities listed in the dataset
1. Wrote *logistic_regression()* function to output a tidied logistic regression
results from the *glm()* function. Logistic regression was run to describe
the logit transformation of the probability of a homicide being resolved as a
function of the victim's race, age, and sex.

2. Ran *logistic_regression()* on the homicides for each location in the dataset

3. Calculated the OR and 95% CI for victim race for each city

4. Created **city_state_order** variable to record the order of the OR's of
all the cities

5. Plotted the OR's of a homicide being resolved for a white vs. non-white 
victim after adjusting for age and sex in order of increasing magnitude for
all cities. 
```{r}
logistic_regression <- function(df) {
  broom::tidy(glm(solved_binary ~ victim_age + victim_sex + victim_race, 
                  data = df, family = binomial()))
}

regression_df <- homicide_df %>% 
  group_by(city_state) %>% 
  nest %>% 
  mutate(log_results = purrr::map(data, logistic_regression)) %>% 
  select(city_state, log_results) %>% 
  unnest %>%
  filter(term == "victim_racewhite") %>% 
  mutate(OR = exp(estimate),
         CI_lower_limit = exp(estimate - 1.96*std.error),
         CI_upper_limit = exp(estimate + 1.96*std.error)) %>% 
  select(city_state, estimate, OR, CI_lower_limit, CI_upper_limit)

regression_df

city_state_order <- regression_df$city_state[order(regression_df$OR, 
                                                   decreasing = T)]

regression_df %>% 
  mutate(city_state = readr::parse_factor(city_state, city_state_order)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower_limit, ymax = CI_upper_limit), 
                alpha = 0.5) +
  geom_hline(yintercept = 1, linetype = "longdash", alpha = 0.75) +
  theme(axis.text.y = element_text(size = 4.5)) +
  labs(title = "Comparing the odds of a homicide being resolved for a 
       white vs. non-white victim after adjusting for age and sex",
       x = "Location",
       y = "Odds ratio with 95% confidence intervals") +
  scale_y_continuous(breaks = c(1, 5, 10, 15, 20),
                     labels = c('1', '5', '10', '15', '20')) +
  coord_flip()
```

In all cities except Tampa, Birmingham, and Durham, after accounting for the 
victim's age and sex, a homicide with a white victim has greater odds of being 
resolved compared to a non-white victim (without considering confidence 
intervals). There are a couple of outlier cities such as Boston and Oakland in 
which the odds of a homicide with a white victim being resolved are more than 2 
times the odds of a homicide with a non-white victim being resolved. For several 
cities, the 95% confidence interval does not overlap with the null value of 1, 
which suggests the disparity between homicides with white vs. non-white victims
is statistically significant. 

